<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนเข้างาน</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- QRCode Library (Modern Version) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Alert Banner (แสดงเมื่อใช้ Demo Mode) -->
    <div id="demoBanner" class="hidden w-full max-w-sm bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded shadow-sm" role="alert">
        <p class="font-bold">⚠️ โหมดจำลอง (Demo)</p>
        <p class="text-sm">กำลังแสดงข้อมูลตัวอย่างเนื่องจาก LIFF ID ไม่ถูกต้อง หรือยังไม่ได้ตั้งค่า</p>
    </div>

    <!-- Card แสดงผล -->
    <div id="card" class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm text-center hidden">
        <div class="mb-4 relative inline-block">
            <img id="profileImg" class="w-24 h-24 rounded-full mx-auto border-4 border-green-500 shadow-sm object-cover" src="" alt="Profile">
        </div>
        <h2 id="displayName" class="text-xl font-bold text-gray-800 mb-1">ชื่อผู้ใช้</h2>
        <p id="statusMsg" class="text-sm text-gray-500 mb-4 px-2 truncate">สถานะ</p>
        
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4 flex justify-center flex-col items-center">
            <p class="text-xs text-gray-400 mb-2">สแกนเพื่อลงทะเบียน</p>
            <!-- QR Code จะถูกสร้างที่นี่ (ใช้ Canvas แทน Div) -->
            <canvas id="qrCanvas" class="rounded border border-gray-100"></canvas>
        </div>

        <p id="genTime" class="text-xs text-gray-400 mb-6">สร้างเมื่อ: --:--</p>
        
        <button onclick="sendToChat()" class="w-full bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            ส่งข้อมูลเข้าแชท
        </button>
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
        <p class="text-gray-600">กำลังโหลด...</p>
        <p id="errorMsg" class="text-red-500 text-sm mt-2 hidden"></p>
    </div>

    <script>
        // ****************************************************
        // แก้ไข LIFF ID ตรงนี้ (ต้องเป็นรูปแบบ ตัวเลข-ตัวอักษร)
        // ดูได้ที่ LINE Developers -> Channel (Login) -> Tab LIFF
        // ****************************************************
        const MY_LIFF_ID = "2008560135-aDKZxE9W"; 
        // ****************************************************

        let csvData = "";
        let isDemoMode = false;

        async function main() {
            const loadingDiv = document.getElementById('loading');

            // กรณี 1: ยังไม่ได้แก้ ID -> เข้า Demo Mode ทันที
            if (MY_LIFF_ID === "YOUR_LIFF_ID_HERE" || MY_LIFF_ID === "") {
                console.warn("LIFF ID not set. Switching to Demo Mode.");
                useMockData();
                return;
            }

            // กรณี 2: มี ID แต่เชื่อมต่อไม่ได้ (เช่น ID ผิด) -> เข้า Demo Mode พร้อมแจ้ง Error ใน Console
            try {
                await liff.init({ liffId: MY_LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                renderCard(profile.userId, profile.displayName, profile.pictureUrl, profile.statusMessage);

            } catch (err) {
                console.error("LIFF Init Error:", err);
                useMockData();
            }
        }

        // ฟังก์ชันจำลองข้อมูล (ทำงานเมื่อเชื่อมต่อ LINE ไม่ได้)
        function useMockData() {
            isDemoMode = true;
            document.getElementById('demoBanner').classList.remove('hidden');
            
            // ข้อมูลสมมติ
            const mockProfile = {
                userId: "U1234567890abcdef1234567890abcdef",
                displayName: "สมชาย ใจดี (จำลอง)",
                pictureUrl: "https://api.dicebear.com/7.x/avataaars/svg?seed=Somchai", 
                statusMessage: "พร้อมทำงานครับ! (ข้อมูลยาวๆก็รับได้แล้วนะครับ)"
            };

            renderCard(mockProfile.userId, mockProfile.displayName, mockProfile.pictureUrl, mockProfile.statusMessage);
        }

        function renderCard(userId, displayName, pictureUrl, statusMessage) {
            const loadingDiv = document.getElementById('loading');
            const cardDiv = document.getElementById('card');
            const errorMsg = document.getElementById('errorMsg');

            const date = new Date();
            const timeString = date.toLocaleString('th-TH');
            
            // Clean Data
            const cleanName = (displayName || "").replace(/,/g, "");
            const cleanStatus = (statusMessage || "-").replace(/,/g, "");
            
            // CSV Format: ID,Name,Picture,Status,Time
            csvData = `${userId},${cleanName},${pictureUrl},${cleanStatus},${timeString}`;

            // Render UI
            document.getElementById('profileImg').src = pictureUrl || "https://via.placeholder.com/150";
            document.getElementById('displayName').innerText = displayName;
            document.getElementById('statusMsg').innerText = statusMessage || "-";
            document.getElementById('genTime').innerText = "สร้างเมื่อ: " + timeString;

            // Generate QR Code using modern library
            const canvas = document.getElementById('qrCanvas');
            
            QRCode.toCanvas(canvas, csvData, { 
                width: 200,
                margin: 2,
                color: {
                    dark: "#000000",
                    light: "#ffffff"
                }
            }, function (error) {
                if (error) {
                    console.error("QR Error:", error);
                    errorMsg.innerText = "สร้าง QR Code ไม่สำเร็จ: " + error;
                    errorMsg.style.display = 'block';
                } else {
                    loadingDiv.style.display = 'none';
                    cardDiv.style.display = 'block';
                }
            });
        }

        async function sendToChat() {
            if (isDemoMode) {
                alert("นี่คือโหมดจำลอง: ข้อมูลจะถูกส่งจริงเมื่อคุณใส่ LIFF ID ที่ถูกต้องและเปิดผ่าน LINE App");
                return;
            }

            if (!liff.isInClient()) {
                alert("ฟังก์ชันส่งข้อความใช้งานได้เฉพาะบนแอป LINE ในมือถือเท่านั้น");
                return;
            }

            try {
                await liff.sendMessages([
                    {
                        type: "text",
                        text: "ข้อมูลลงทะเบียน:\n" + csvData
                    }
                ]);
                liff.closeWindow();
            } catch (err) {
                alert("ส่งไม่สำเร็จ: " + err.message);
            }
        }

        main();
    </script>
</body>
</html>
