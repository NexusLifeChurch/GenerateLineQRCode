<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- QRCode Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Tailwind CSS (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô CSS ‡πÄ‡∏¢‡∏≠‡∏∞) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Loading Screen -->
    <div id="loading" class="text-center text-gray-600">
        <svg class="animate-spin h-8 w-8 text-green-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</p>
        <p class="text-xs text-gray-400 mt-2">‡∏´‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF ID</p>
    </div>

    <!-- Main Card -->
    <div id="card" class="bg-white rounded-2xl card-shadow w-full max-w-sm overflow-hidden hidden">
        <!-- Header -->
        <div class="bg-green-500 h-24 relative">
            <div class="absolute -bottom-10 left-1/2 transform -translate-x-1/2">
                <img id="profileImg" src="https://via.placeholder.com/150" alt="Profile" class="w-20 h-20 rounded-full border-4 border-white object-cover">
            </div>
        </div>
        
        <!-- Profile Info -->
        <div class="pt-12 pb-4 text-center px-4">
            <h1 id="displayName" class="text-xl font-bold text-gray-800">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>
            <p id="statusMsg" class="text-sm text-gray-500 mt-1 truncate">Status Message</p>
            
            <div class="mt-4 bg-green-50 px-4 py-2 rounded-lg inline-block">
                 <p class="text-xs text-green-700 font-semibold">User ID (Last 4): <span id="userIdShort">...</span></p>
            </div>
        </div>

        <!-- QR Code Section -->
        <div class="flex flex-col items-center justify-center bg-gray-50 py-6 border-t border-b border-gray-100">
            <div id="qrcode" class="p-2 bg-white rounded-lg shadow-sm border"></div>
            <p class="text-xs text-gray-400 mt-3">‡πÅ‡∏™‡∏î‡∏á QR Code ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô</p>
        </div>

        <!-- Timestamp & Action -->
        <div class="p-4 text-center">
            <p id="genTime" class="text-xs text-gray-400 mb-4">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á: -</p>
            
            <button onclick="sendToChat()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                </svg>
                ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
            </button>
        </div>
    </div>

    <!-- Script -->
    <script>
        // ******************************************************
        // üî¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏™‡πà LIFF ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö XXXXX-XXXXX)
        const MY_LIFF_ID = "2008560135-aDKZxE9W"; 
        // ******************************************************

        let profileData = null;
        let csvContent = "";

        async function main() {
            try {
                // Initialize LIFF
                await liff.init({ liffId: MY_LIFF_ID });

                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á Login
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                const profile = await liff.getProfile();
                profileData = profile;

                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                document.getElementById('profileImg').src = profile.pictureUrl || "https://via.placeholder.com/150";
                document.getElementById('displayName').innerText = profile.displayName;
                document.getElementById('statusMsg').innerText = profile.statusMessage || "-";
                document.getElementById('userIdShort').innerText = "..." + profile.userId.slice(-4);

                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR Code (CSV)
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: UserId, DisplayName, URL‡∏£‡∏π‡∏õ, ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞, ‡πÄ‡∏ß‡∏•‡∏≤
                const now = new Date();
                const timeString = now.toLocaleString('th-TH');
                document.getElementById('genTime').innerText = "‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á: " + timeString;

                // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ (,) ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ CSV ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
                const cleanName = (profile.displayName || "").replace(/,/g, " ");
                const cleanStatus = (profile.statusMessage || "").replace(/,/g, " ");

                csvContent = `${profile.userId},${cleanName},${profile.pictureUrl},${cleanStatus},${timeString}`;

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
                const qrcodeContainer = document.getElementById("qrcode");
                qrcodeContainer.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
                new QRCode(qrcodeContainer, {
                    text: csvContent,
                    width: 180,
                    height: 180,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });

                // ‡∏ã‡πà‡∏≠‡∏ô Loading ‡πÅ‡∏™‡∏î‡∏á Card
                document.getElementById('loading').style.display = 'none';
                document.getElementById('card').classList.remove('hidden');

            } catch (err) {
                console.error("LIFF Error:", err);
                document.getElementById('loading').innerHTML = `
                    <p class="text-red-500 font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</p>
                    <p class="text-sm text-gray-600 mt-2">${err.code || ''} ${err.message}</p>
                    <p class="text-xs text-gray-400 mt-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF ID ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</p>
                `;
            }
        }

        async function sendToChat() {
            if (!liff.isInClient()) {
                alert("‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
                return;
            }
            
            try {
                // ‡∏™‡πà‡∏á Flex Message ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
                // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ QR Code ‡∏ï‡∏£‡∏á‡πÜ ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ó‡∏ô
                await liff.sendMessages([
                    {
                        type: "flex",
                        altText: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á " + profileData.displayName,
                        contents: {
                            "type": "bubble",
                            "hero": {
                                "type": "image",
                                "url": profileData.pictureUrl,
                                "size": "full",
                                "aspectRatio": "20:13",
                                "aspectMode": "cover"
                            },
                            "body": {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [
                                {
                                    "type": "text",
                                    "text": profileData.displayName,
                                    "weight": "bold",
                                    "size": "xl"
                                },
                                {
                                    "type": "box",
                                    "layout": "vertical",
                                    "margin": "lg",
                                    "spacing": "sm",
                                    "contents": [
                                    {
                                        "type": "box",
                                        "layout": "baseline",
                                        "spacing": "sm",
                                        "contents": [
                                        {
                                            "type": "text",
                                            "text": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
                                            "color": "#aaaaaa",
                                            "size": "sm",
                                            "flex": 1
                                        },
                                        {
                                            "type": "text",
                                            "text": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô",
                                            "wrap": true,
                                            "color": "#666666",
                                            "size": "sm",
                                            "flex": 5
                                        }
                                        ]
                                    },
                                    {
                                        "type": "box",
                                        "layout": "baseline",
                                        "spacing": "sm",
                                        "contents": [
                                        {
                                            "type": "text",
                                            "text": "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                                            "color": "#aaaaaa",
                                            "size": "sm",
                                            "flex": 1
                                        },
                                        {
                                            "type": "text",
                                            "text": csvContent, // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV text ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                                            "wrap": true,
                                            "color": "#666666",
                                            "size": "xs",
                                            "flex": 5
                                        }
                                        ]
                                    }
                                    ]
                                }
                                ]
                            }
                        }
                    }
                ]);
                liff.closeWindow();
            } catch (err) {
                console.error(err);
                alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        main();
    </script>
</body>
</html>
