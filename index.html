<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My QR Code Pass</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; text-align: center; padding: 20px; background-color: #f0f0f0; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        #qrcode { margin-top: 20px; display: flex; justify-content: center; }
        img.profile { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; }
        .btn { background-color: #00B900; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 20px; font-size: 16px;}
        .loading { color: #888; }
    </style>
</head>
<body>

    <div class="card" id="card" style="display:none;">
        <img id="profileImg" class="profile" src="" alt="Profile">
        <h2 id="displayName">Name</h2>
        <p id="statusMsg" style="color:gray; font-size:14px;"></p>
        <hr>
        <div id="qrcode"></div>
        <p id="genTime" style="margin-top:10px; font-size:12px; color:#555;"></p>
        
        <button class="btn" onclick="sendToChat()">ส่งเข้าแชทเก็บไว้</button>
    </div>

    <div id="loading" class="loading">กำลังโหลดข้อมูล...</div>

    <script>
        // *** ใส่ LIFF ID ของคุณที่นี่ ***
        const MY_LIFF_ID = "YOUR_LIFF_ID_HERE"; 
        
        let userProfile = {};
        let csvData = "";

        async function main() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                userProfile = profile;
                
                // 1. เตรียมข้อมูล
                const date = new Date();
                const timeString = date.toLocaleString('th-TH');
                
                // สร้าง CSV: ID, Name, Pic, Status, Time
                // ระวัง: การใช้ comma (,) ในข้อมูลอาจทำให้ CSV เพี้ยน ควรแทนที่ก่อน หรือใช้ตัวคั่นอื่น เช่น |
                csvData = `${profile.userId},${profile.displayName},${profile.pictureUrl},${profile.statusMessage || '-'},${timeString}`;

                // 2. แสดงผลบนหน้าเว็บ
                document.getElementById('profileImg').src = profile.pictureUrl;
                document.getElementById('displayName').innerText = profile.displayName;
                document.getElementById('statusMsg').innerText = profile.statusMessage;
                document.getElementById('genTime').innerText = "สร้างเมื่อ: " + timeString;

                // 3. สร้าง QR Code
                new QRCode(document.getElementById("qrcode"), {
                    text: csvData,
                    width: 200,
                    height: 200
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('card').style.display = 'block';

            } catch (err) {
                console.error(err);
                alert("เกิดข้อผิดพลาด: " + err.message);
            }
        }

        // ฟังก์ชันส่ง Flex Message กลับเข้าห้องแชท
        async function sendToChat() {
            if (!liff.isInClient()) {
                alert("ฟังก์ชันนี้ใช้ได้เมื่อเปิดผ่าน LINE เท่านั้น");
                return;
            }
            
            try {
                // สร้าง Flex Message จำลอง (คุณต้องไปออกแบบ JSON Flex ให้สวยงามใน Line Bot Designer)
                // ข้อจำกัด: liff.sendMessages ส่งรูป QR Code ที่ gen จาก canvas โดยตรงยาก 
                // ปกติเราจะส่งเป็น Text ข้อมูล หรือ Link แทน หรือต้องมี Server Gen รูป
                // แต่เบื้องต้นส่งเป็นข้อมูลสรุปไปก่อน
                await liff.sendMessages([
                    {
                        type: "text",
                        text: "ข้อมูลลงทะเบียนของฉัน:\n" + csvData
                    }
                ]);
                liff.closeWindow();
            } catch (err) {
                alert("ส่งข้อความไม่สำเร็จ: " + err);
            }
        }

        main();
    </script>
</body>
</html>
